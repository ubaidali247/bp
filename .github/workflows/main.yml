name: CI-CD Pipeline (Build, Test, SonarCloud, Blue/Green Deploy)

on:
  push:
    branches: 
      - "**"
  pull_request:
    branches:
      - master
      - staging

jobs:

  # -------------------------------------------------------
  # 1. CI JOB â†’ build, test, SonarCloud (runs on every branch)
  # -------------------------------------------------------
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: "9.0.x"

      - name: Restore dependencies
        run: dotnet restore

      - name: Install SonarScanner
        run: |
          dotnet tool install --global dotnet-sonarscanner --version 5.14.0 || true
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: SonarCloud - Begin Analysis
        if: ${{ env.SONAR_TOKEN != '' }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          dotnet sonarscanner begin \
            /k:"ubaidali247_bp" \
            /o:"ubaidali247" \
            /d:sonar.login="${SONAR_TOKEN}" \
            /d:sonar.host.url="https://sonarcloud.io" \
            /d:sonar.cs.opencover.reportsPaths="**/coverage.opencover.xml"

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Install Playwright Browsers
        run: pwsh tests/BPCalculator.E2E/bin/Release/net8.0/playwright.ps1 install --with-deps chromium
        continue-on-error: false

      - name: Test and Generate Coverage
        run: dotnet test --verbosity normal /p:CollectCoverage=true /p:CoverletOutput=coverage.opencover.xml /p:CoverletOutputFormat=opencover

      - name: SonarCloud - End Analysis
        if: ${{ env.SONAR_TOKEN != '' }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: dotnet sonarscanner end /d:sonar.login="${SONAR_TOKEN}"

      - name: Publish App Artifact
        run: dotnet publish -c Release -o "published"

      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          name: published-app
          path: published

  # -------------------------------------------------------
  # 2. DEPLOY TO STAGING SLOT (Green)
  # -------------------------------------------------------
  deploy_staging_slot:
    runs-on: windows-latest
    needs: ci
    if: github.ref == 'refs/heads/staging' || github.ref == 'refs/heads/master'

    steps:
      - name: Download Artifact
        uses: actions/download-artifact@v4
        with:
          name: published-app

      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Staging Slot (green)
        uses: azure/webapps-deploy@v3
        with:
          app-name: "bp-app"
          slot-name: "green"
          package: "published"

  # -------------------------------------------------------
  # 3. SMOKE TESTS / BDD
  # -------------------------------------------------------
  smoke_test_slot:
    runs-on: windows-latest
    needs: deploy_staging_slot
    steps:
      - name: Simple HTTP check
        shell: pwsh
        run: |
          $url = "https://bp-app-green.azurewebsites.net/health"
          $response = Invoke-WebRequest -Uri $url -UseBasicParsing
          if ($response.StatusCode -ne 200) {
              Write-Error "Smoke test failed! HTTP Status: $($response.StatusCode)"
          } else {
              Write-Host "Smoke test passed! HTTP Status: $($response.StatusCode)"
          }

      - name: Run BDD / Integration Tests
        run: dotnet test --filter TestCategory=BDD

  # -------------------------------------------------------
  # 4. SWAP GREEN -> PRODUCTION
  # -------------------------------------------------------
  swap_to_production:
    runs-on: ubuntu-latest
    needs: smoke_test_slot
    if: github.ref == 'refs/heads/master'

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Swap Green -> Production
        run: |
          az webapp deployment slot swap \
            --resource-group YOUR_RESOURCE_GROUP \
            --name bp-app \
            --slot green \
            --target-slot production

  # -------------------------------------------------------
  # 5. POST-SWAP VALIDATION + ROLLBACK
  # -------------------------------------------------------
  post_swap_validation:
    runs-on: ubuntu-latest
    needs: swap_to_production

    steps:
      - name: Azure Login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Validate Production Health
        run: |
          $url = "https://bp-app.azurewebsites.net/health"
          $status = curl -s -o /dev/null -w "%{http_code}" $url
          echo "Production status: $status"
          if [ "$status" -ne 200 ]; then
            echo "Production validation failed. Rolling back..."
            az webapp deployment slot swap --resource-group YOUR_RESOURCE_GROUP --name bp-app --slot green --target-slot production
            exit 1
          fi
