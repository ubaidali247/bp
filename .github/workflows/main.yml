name: CI-CD Pipeline (Build, Test, SonarCloud, Deploy Staging/Prod)

on:
  push:
    branches: 
      - "**"
  pull_request:
    branches:
      - master
      - staging

jobs:

  # -------------------------------------------------------
  # 1. CI JOB → build, test, sonarcloud (runs on every branch)
  # -------------------------------------------------------
  ci:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup .NET
        uses: actions/setup-dotnet@v3
        with:
          dotnet-version: "9.0.x"

      - name: Restore dependencies
        run: dotnet restore

      - name: Install SonarScanner
        run: |
          dotnet tool install --global dotnet-sonarscanner --version 5.14.0 || true
          echo "$HOME/.dotnet/tools" >> $GITHUB_PATH

      - name: SonarCloud - Begin Analysis
        if: ${{ env.SONAR_TOKEN != '' }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          dotnet sonarscanner begin \
            /k:"ubaidali247_bp" \
            /o:"ubaidali247" \
            /d:sonar.login="${SONAR_TOKEN}" \
            /d:sonar.host.url="https://sonarcloud.io" \
            /d:sonar.cs.opencover.reportsPaths="**/coverage.opencover.xml"

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Install Playwright Browsers
        run: pwsh tests/BPCalculator.E2E/bin/Release/net8.0/playwright.ps1 install --with-deps chromium
        continue-on-error: false

      - name: Test and Generate Coverage
        run: dotnet test --verbosity normal /p:CollectCoverage=true /p:CoverletOutput=coverage.opencover.xml /p:CoverletOutputFormat=opencover

      - name: SonarCloud - End Analysis
        if: ${{ env.SONAR_TOKEN != '' }}
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: dotnet sonarscanner end /d:sonar.login="${SONAR_TOKEN}"


  # -------------------------------------------------------
  # 2. DEPLOY TO STAGING → only on staging branch
  # -------------------------------------------------------
  deploy_staging:
    runs-on: windows-latest
    needs: ci
    if: github.ref == 'refs/heads/staging'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.x'

      - name: Publish App
        run: dotnet publish -c Release -o "published"

      - name: Deploy to Azure Staging
        uses: azure/webapps-deploy@v3
        with:
          app-name: "bp-app-staging"
          publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_9DB31DFF220F4A68B53A16107CE92F7B }}
          package: "published"


  # -------------------------------------------------------
  # 3. SMOKE TESTS (Only after staging deploy)
  # -------------------------------------------------------
  smoke_test:
    runs-on: windows-latest
    needs: deploy_staging
    if: github.ref == 'refs/heads/staging'

    steps:
      - name: Simple HTTP check
        shell: pwsh
        run: |
          $url = "https://bp-app-staging-hqhsbkf3ezhkhmh8.francecentral-01.azurewebsites.net/"
          $response = Invoke-WebRequest -Uri $url -UseBasicParsing
          if ($response.StatusCode -ne 200) {
              Write-Error "Smoke test failed! HTTP Status: $($response.StatusCode)"
          } else {
              Write-Host "Smoke test passed! HTTP Status: $($response.StatusCode)"
          }


  # -------------------------------------------------------
  # 4. DEPLOY TO GREEN SLOT (Blue-Green Step 1)
  # -------------------------------------------------------
  deploy_to_green_slot:
    runs-on: windows-latest
    needs: ci
    if: github.ref == 'refs/heads/master'

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '9.x'

      - name: Publish App
        run: dotnet publish -c Release -o "published"

      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_6599CACD2F1F4439935635D7D9794176 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_196F7C91A67E43AC9556CC646674D709 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_70341DED43AB45308F84726349690B1E }}

      - name: Deploy to Green Slot
        uses: azure/webapps-deploy@v3
        with:
          app-name: "bp-app"
          slot-name: "green"
          package: "published"


  # -------------------------------------------------------
  # 5. TEST GREEN SLOT (Blue-Green Step 2)
  # -------------------------------------------------------
  test_green_slot:
    runs-on: windows-latest
    needs: deploy_to_green_slot
    if: github.ref == 'refs/heads/master'

    steps:
      - name: Wait for deployment to settle
        shell: pwsh
        run: Start-Sleep -Seconds 30

      - name: Smoke Test Green Slot
        shell: pwsh
        run: |
          $url = "https://bp-app-green-d0gnanazdzhgdrcs.francecentral-01.azurewebsites.net/"
          Write-Host "Testing green slot: $url"
          
          $response = Invoke-WebRequest -Uri $url -UseBasicParsing -TimeoutSec 30
          if ($response.StatusCode -eq 200) {
              Write-Host "✓ Green slot is healthy! HTTP Status: $($response.StatusCode)"
          } else {
              Write-Error "❌ Green slot test failed! HTTP Status: $($response.StatusCode)"
              exit 1
          }


  # -------------------------------------------------------
  # 6. SWAP TO PRODUCTION (Blue-Green Step 3)
  # -------------------------------------------------------
  swap_to_production:
    runs-on: windows-latest
    needs: test_green_slot
    if: github.ref == 'refs/heads/master'

    permissions:
      id-token: write
      contents: read

    steps:
      - name: Azure Login (OIDC)
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZUREAPPSERVICE_CLIENTID_6599CACD2F1F4439935635D7D9794176 }}
          tenant-id: ${{ secrets.AZUREAPPSERVICE_TENANTID_196F7C91A67E43AC9556CC646674D709 }}
          subscription-id: ${{ secrets.AZUREAPPSERVICE_SUBSCRIPTIONID_70341DED43AB45308F84726349690B1E }}

      - name: Swap Green to Production
        shell: pwsh
        run: |
          Write-Host "Swapping green slot to production..."
          az webapp deployment slot swap `
            --name bp-app `
            --resource-group ${{ secrets.AZURE_RESOURCE_GROUP }} `
            --slot green `
            --target-slot production

      - name: Verify Production
        shell: pwsh
        run: |
          Start-Sleep -Seconds 15
          $url = "https://bp-app-cnega2e8cfcneud5.francecentral-01.azurewebsites.net/"
          Write-Host "Verifying production: $url"
          
          $response = Invoke-WebRequest -Uri $url -UseBasicParsing
          if ($response.StatusCode -eq 200) {
              Write-Host "✓ Production swap successful! HTTP Status: $($response.StatusCode)"
          } else {
              Write-Error "❌ Production verification failed!"
              exit 1
          }
